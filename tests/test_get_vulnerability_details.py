"""Tests for get_vulnerability_details function."""

from unittest.mock import Mock

import pytest

from helix_tenable_mcp.server import get_vulnerability_details


class TestGetVulnerabilityDetails:
    """Test suite for get_vulnerability_details function."""

    def test_get_details_with_valid_plugin_id(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
        sample_plugin_details: dict,
    ) -> None:
        """Test getting vulnerability details with a valid plugin ID."""
        # Arrange
        mock_tenable_client.plugins.plugin_details.return_value = sample_plugin_details

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert result["plugin_id"] == 123456
        assert result["name"] == "Test Vulnerability"
        assert result["family"] == "Web Servers"
        assert result["severity"] == "Critical"
        assert result["cvss_base_score"] == 9.8
        assert result["cvss3_base_score"] == 9.8
        assert result["cve"] == ["CVE-2025-55182"]
        assert result["exploit_available"] is True
        assert result["exploitability_ease"] == "Exploits are available"

        # Verify correct API call
        mock_tenable_client.plugins.plugin_details.assert_called_once_with(123456)

    def test_get_details_includes_all_fields(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
        sample_plugin_details: dict,
    ) -> None:
        """Test that all expected fields are included in the result."""
        # Arrange
        mock_tenable_client.plugins.plugin_details.return_value = sample_plugin_details

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        expected_fields = [
            "plugin_id",
            "name",
            "family",
            "severity",
            "cvss_base_score",
            "cvss3_base_score",
            "cvss_vector",
            "cvss3_vector",
            "description",
            "solution",
            "synopsis",
            "cve",
            "exploit_available",
            "exploitability_ease",
            "patch_publication_date",
            "vulnerability_publication_date",
            "see_also",
        ]
        for field in expected_fields:
            assert field in result, f"Missing expected field: {field}"

    def test_get_details_handles_missing_cve_attribute(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
    ) -> None:
        """Test handling when CVE attribute is missing."""
        # Arrange
        plugin_data = {
            "id": 123456,
            "name": "Test Vulnerability",
            "risk_factor": "Medium",
            "attributes": {},  # No cve field
        }
        mock_tenable_client.plugins.plugin_details.return_value = plugin_data

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert result["plugin_id"] == 123456
        assert result["cve"] == []  # Should be empty list, not error

    def test_get_details_handles_no_attributes(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
    ) -> None:
        """Test handling when attributes field is missing entirely."""
        # Arrange
        plugin_data = {
            "id": 123456,
            "name": "Test Vulnerability",
            "risk_factor": "Medium",
        }
        mock_tenable_client.plugins.plugin_details.return_value = plugin_data

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert result["plugin_id"] == 123456
        assert result["cve"] == []

    def test_get_details_handles_api_error(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
    ) -> None:
        """Test error handling when API call fails."""
        # Arrange
        mock_tenable_client.plugins.plugin_details.side_effect = Exception(
            "Plugin not found"
        )

        # Act
        result = get_vulnerability_details(999999)

        # Assert
        assert "error" in result
        assert result["error"] == "Plugin not found"
        assert result["plugin_id"] == 999999

    def test_get_details_with_multiple_cves(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
        sample_plugin_details: dict,
    ) -> None:
        """Test plugin details with multiple associated CVEs."""
        # Arrange
        sample_plugin_details["attributes"]["cve"] = [
            "CVE-2025-55182",
            "CVE-2025-55183",
            "CVE-2025-55184",
        ]
        mock_tenable_client.plugins.plugin_details.return_value = sample_plugin_details

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert len(result["cve"]) == 3
        assert "CVE-2025-55182" in result["cve"]
        assert "CVE-2025-55183" in result["cve"]
        assert "CVE-2025-55184" in result["cve"]

    def test_get_details_with_no_exploit_available(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
        sample_plugin_details: dict,
    ) -> None:
        """Test plugin details when no exploit is available."""
        # Arrange
        sample_plugin_details["exploit_available"] = False
        sample_plugin_details["exploitability_ease"] = "No known exploits are available"
        mock_tenable_client.plugins.plugin_details.return_value = sample_plugin_details

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert result["exploit_available"] is False
        assert result["exploitability_ease"] == "No known exploits are available"

    def test_get_details_handles_missing_optional_fields(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
    ) -> None:
        """Test that missing optional fields return None instead of causing errors."""
        # Arrange
        minimal_plugin = {
            "id": 123456,
            "name": "Minimal Plugin",
        }
        mock_tenable_client.plugins.plugin_details.return_value = minimal_plugin

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert result["plugin_id"] == 123456
        assert result["name"] == "Minimal Plugin"
        assert result["family"] is None
        assert result["severity"] is None
        assert result["description"] is None
        assert result["solution"] is None

    def test_get_details_preserves_see_also_links(
        self,
        mock_env_vars: None,
        mock_tenable_client: Mock,
        patch_get_tenable_client: Mock,
        sample_plugin_details: dict,
    ) -> None:
        """Test that see_also links are preserved correctly."""
        # Arrange
        sample_plugin_details["see_also"] = [
            "https://example.com/advisory1",
            "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-55182",
        ]
        mock_tenable_client.plugins.plugin_details.return_value = sample_plugin_details

        # Act
        result = get_vulnerability_details(123456)

        # Assert
        assert len(result["see_also"]) == 2
        assert "https://example.com/advisory1" in result["see_also"]
